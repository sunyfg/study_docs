# 线上监控和报警

一个完善的线上产品，必须有完善的运维体系，才能保证稳定运行。包括服务器监控，报警，以及网络安全预防。

一个软件的生命周期，可以分为：研发＋迭代十运维，其中运维最重要。运维里，监控和报警是最重要的。即，哪个最靠近“稳定安全的运行“，哪个就最重要。作为架构师，要深刻意识到这一点。不一定自己做，但一定要知道。

* 异常处理和安全预防
* 监控和报警

### 关键词

* 运维
* 监控
* 报警
* 心跳检测
* 安全

## 异常处理和安全预防

* 统一异常处理
* 安全预防
* 防止网络攻击 - 阿里云网络防火墙 WAF

## 统一异常处理

koa 中间件 onerror

### 预防内存泄漏

在 pm2 配置中增加 `max_memory_restart:'300M'`，这样内存使用超过 300M 就会重启。

* 如果观察 pm2 重启频繁，那要去排查一下内存泄漏的问题
* 如果观察 pm2 重启不频繁，那可以不用着急解决，先观察这再说

架构师要以全面视角去看待问题，而不是仅仅以纯技术角度来看待。内存泄漏，不一定就必须要解决。

再举一个例子：假如有一个算法，空间复杂度较高，古内存较大。此时，你是花高薪聘请技术专家解决，还是花钱扩展一下机器内存？一答案显而易见

## 安全预防

常见 Web 攻击：

* SQL 注入
* XSS 攻击
* CSRF
* 网络攻击

### SQL 注入

使用 sequelize 可以防止，不用可以去解决

PS：只要不裸写 sql 语句，常见的数据库工具，都可解决 sql 注入的问题

### XSS 攻击

通过 vue 和 React 可以防止。h5 也可以通过 vue ssr 防止

* vue 中要输入原生 html 需要用 v-html
* react 中要使用 dangerouslySetInnerHTML

单独处理可以使用：

* https://github.com/component/escape-html 
* xss 包 https://jsxss.com/zh/index.html

### CSRF 跨站请求伪造

* 提交数据都是用 post 请求
* jwt 有 token 检查

### 优化请求头

使用 helemt 优化请求头 https://github.com/venables/koa-helmet

### 预防网络攻击

网络攻击，是web 服务的程序解决不了的，也不是程序员所专长的领域。例如，常见的 DDOS 攻击，就是用杰量的、动态的请求，去频繁的访问一个网站，直到这个网站挂掉为止。特别是针对一些中小型网站，阮一峰的个人网站曾遭遇过 DDOS 攻击。

配置阿里云 WAF 网络防火墙

### 短信验证码接口

限制单个手机号发送频率，每日短信上限报警。

WAF 来做一个单 IP 的频率设置，需要单独收费，很贵。

## 监控和报警

* 业务功能检测
* 系统检测：cpu、内存、硬盘

### 定时检测（心跳检测）

cron 定时任务

心跳检测服务：保证接口没有挂

大厂自研监控服务

### 报警

报警方式：

* 短信
* 邮件
* 报警群

报警范围：

* 心跳检测
* 统一异常处理
  * middlewares/error.js
* 核心流程
  * 创建
  * 保存
  * 发布
* 第三方服务
  * 短信验证码
  * 邮箱验证码
  * 等等

## alinode 服务器监控

https://www.aliyun.com/product/nodejs

* CPU使用率
* 内存使用率
* 磁盘使用率



